(defun mli-p (path)
  (and (not (file-directory-p path))
       (or (equal (file-name-extension path) "mli")
	 (equal (file-name-extension path) "shutoffmli"))))

(defun transform-path (old-path)
  (let* ((old-filename (file-name-sans-extension old-path))
	 (old-extension (file-name-extension old-path))
	 (new-extension (cond ((equal old-extension "mli") "shutoffmli")
			      ((equal old-extension "shutoffmli") "mli")
			      (t old-extension)))
	 (new-path (if old-extension
		       (file-name-with-extension old-filename new-extension)
		     old-path)))
    new-path))

(defun mli-dired-toggle ()
  (interactive)
  (let* ((old-path (dired-get-filename))
	 (new-path (transform-path old-path)))
    (unless (mli-p old-path)
      (error "Not an .mli file."))
    (rename-file old-path new-path)
    (revert-buffer)))

(defun suitable-buffer-p ()
  (if buffer-file-name
      (let ((current-extension (file-name-extension buffer-file-name)))
	(or (eq major-mode 'tuareg-mode)
	    (equal current-extension "shutoffmli")))
    nil))

(defun mli-buffer-toggle ()
  (if (suitable-buffer-p)
      (let* ((old-path buffer-file-name)
	     (new-path (transform-path old-path)))
	(rename-file old-path new-path)
	(find-alternate-file new-path)
	(revert-buffer nil t))
    (message "You aren't in a Tuareg buffer.")))

(defun mli-toggle ()
  (cond ((suitable-buffer-p) (mli-buffer-toggle))
	((eq major-mode 'dired-mode) (mli-dired-toggle))
	(t nil))
